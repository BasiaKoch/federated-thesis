Loading rhel8/default-amp
  Loading requirement: singularity/current cuda/11.4
    libpciaccess/0.16/gcc-9.4.0-6fonbj6 libiconv/1.16/gcc-9.4.0-ahebbov
    libxml2/2.9.12/gcc-9.4.0-gnknt5e ncurses/6.2/gcc-9.4.0-aiirok7
    hwloc/2.5.0/gcc-9.4.0-7sqomga libevent/2.1.12/gcc-9.4.0-hgny7cm
    numactl/2.0.14/gcc-9.4.0-52dwc6n cuda/11.4.0/gcc-9.4.0-3hnxhjt
    gdrcopy/2.2/gcc-9.4.0-e4igtfp knem/1.1.4/gcc-9.4.0-bpbxgva
    libnl/3.3.0/gcc-9.4.0-whwhrwb rdma-core/34.0/gcc-9.4.0-5eo5n2u
    ucx/1.11.1/gcc-9.4.0-lktqyl4 openmpi/4.1.1/gcc-9.4.0-epagguv
[93mWARNING [0m:   DEPRECATED FEATURE: flwr.simulation.start_simulation() is deprecated.
	Instead, use the `flwr run` CLI command to start a local simulation in your Flower app, as shown for example below:

		$ flwr new  # Create a new Flower app from a template

		$ flwr run  # Run the Flower app in Simulation Mode

	Using `start_simulation()` is deprecated.

            This is a deprecated feature. It will be removed
            entirely in future versions of Flower.
        
[92mINFO [0m:      Starting Flower simulation, config: num_rounds=10, no round_timeout
2026-01-27 10:31:04,142	INFO worker.py:1771 -- Started a local Ray instance.
[92mINFO [0m:      Flower VCE: Ray initialized with resources: {'accelerator_type:A100': 1.0, 'node:10.43.74.2': 1.0, 'node:__internal_head__': 1.0, 'CPU': 128.0, 'memory': 864787749888.0, 'object_store_memory': 200000000000.0, 'GPU': 1.0}
[92mINFO [0m:      Optimize your simulation with Flower VCE: https://flower.ai/docs/framework/how-to-run-simulations.html
[92mINFO [0m:      Flower VCE: Resources for each Virtual Client: {'num_cpus': 1, 'num_gpus': 1}
[92mINFO [0m:      Flower VCE: Creating VirtualClientEngineActorPool with 1 actors
[92mINFO [0m:      [INIT]
[92mINFO [0m:      Requesting initial parameters from one random client
[36m(ClientAppActor pid=187008)[0m [93mWARNING [0m:   DEPRECATED FEATURE: `client_fn` now expects a signature `def client_fn(context: Context)`.The provided `client_fn` has signature: {'cid': <Parameter "cid: str">}. You can import the `Context` like this: `from flwr.common import Context`
[36m(ClientAppActor pid=187008)[0m 
[36m(ClientAppActor pid=187008)[0m             This is a deprecated feature. It will be removed
[36m(ClientAppActor pid=187008)[0m             entirely in future versions of Flower.
[36m(ClientAppActor pid=187008)[0m         
[92mINFO [0m:      Received initial parameters from one random client
[92mINFO [0m:      Starting evaluation of initial global parameters
[36m(ClientAppActor pid=187008)[0m [93mWARNING [0m:   Deprecation Warning: The `client_fn` function must return an instance of `Client`, but an instance of `NumpyClient` was returned. Please use `NumPyClient.to_client()` method to convert it to `Client`.
[92mINFO [0m:      initial parameters (loss, other metrics): 2.622900931923478, {'client0_meanDice': 0.025083735585212708, 'client0_WT': 0.03683400899171829, 'client0_TC': 0.028188012540340424, 'client0_ET': 0.010229183360934258, 'client1_meanDice': 0.025083735585212708, 'client1_WT': 0.03683400899171829, 'client1_TC': 0.028188012540340424, 'client1_ET': 0.010229183360934258, 'global_meanDice': 0.025083735585212708, 'global_WT': 0.03683401271700859, 'global_TC': 0.028188012540340424, 'global_ET': 0.010229184292256832}
[92mINFO [0m:      
[92mINFO [0m:      [ROUND 1]
[92mINFO [0m:      configure_fit: strategy sampled 2 clients (out of 2)
[36m(ClientAppActor pid=187008)[0m [93mWARNING [0m:   DEPRECATED FEATURE: `client_fn` now expects a signature `def client_fn(context: Context)`.The provided `client_fn` has signature: {'cid': <Parameter "cid: str">}. You can import the `Context` like this: `from flwr.common import Context`
[36m(ClientAppActor pid=187008)[0m 
[36m(ClientAppActor pid=187008)[0m             This is a deprecated feature. It will be removed
[36m(ClientAppActor pid=187008)[0m             entirely in future versions of Flower.
[36m(ClientAppActor pid=187008)[0m         
[36m(ClientAppActor pid=187008)[0m [93mWARNING [0m:   Deprecation Warning: The `client_fn` function must return an instance of `Client`, but an instance of `NumpyClient` was returned. Please use `NumPyClient.to_client()` method to convert it to `Client`.
[36m(ClientAppActor pid=187008)[0m [93mWARNING [0m:   DEPRECATED FEATURE: `client_fn` now expects a signature `def client_fn(context: Context)`.The provided `client_fn` has signature: {'cid': <Parameter "cid: str">}. You can import the `Context` like this: `from flwr.common import Context`
[36m(ClientAppActor pid=187008)[0m 
[36m(ClientAppActor pid=187008)[0m             This is a deprecated feature. It will be removed
[36m(ClientAppActor pid=187008)[0m             entirely in future versions of Flower.
[36m(ClientAppActor pid=187008)[0m         
[36m(ClientAppActor pid=187008)[0m [93mWARNING [0m:   Deprecation Warning: The `client_fn` function must return an instance of `Client`, but an instance of `NumpyClient` was returned. Please use `NumPyClient.to_client()` method to convert it to `Client`.
[92mINFO [0m:      aggregate_fit: received 2 results and 0 failures
[93mWARNING [0m:   No fit_metrics_aggregation_fn provided
[92mINFO [0m:      fit progress: (1, 1.0571670110779579, {'client0_meanDice': 0.004019452258944511, 'client0_WT': 0.006814467720687389, 'client0_TC': 0.0028471508994698524, 'client0_ET': 0.002396737691015005, 'client1_meanDice': 0.004019452258944511, 'client1_WT': 0.006814467720687389, 'client1_TC': 0.0028471508994698524, 'client1_ET': 0.002396737691015005, 'global_meanDice': 0.004019452258944511, 'global_WT': 0.006814467720687389, 'global_TC': 0.0028471508994698524, 'global_ET': 0.002396737691015005}, 536.2704945200239)
[92mINFO [0m:      configure_evaluate: strategy sampled 2 clients (out of 2)
[36m(ClientAppActor pid=187008)[0m [93mWARNING [0m:   DEPRECATED FEATURE: `client_fn` now expects a signature `def client_fn(context: Context)`.The provided `client_fn` has signature: {'cid': <Parameter "cid: str">}. You can import the `Context` like this: `from flwr.common import Context`
[36m(ClientAppActor pid=187008)[0m 
[36m(ClientAppActor pid=187008)[0m             This is a deprecated feature. It will be removed
[36m(ClientAppActor pid=187008)[0m             entirely in future versions of Flower.
[36m(ClientAppActor pid=187008)[0m         
[36m(ClientAppActor pid=187008)[0m [93mWARNING [0m:   Deprecation Warning: The `client_fn` function must return an instance of `Client`, but an instance of `NumpyClient` was returned. Please use `NumPyClient.to_client()` method to convert it to `Client`.
[36m(ClientAppActor pid=187008)[0m [93mWARNING [0m:   DEPRECATED FEATURE: `client_fn` now expects a signature `def client_fn(context: Context)`.The provided `client_fn` has signature: {'cid': <Parameter "cid: str">}. You can import the `Context` like this: `from flwr.common import Context`
[36m(ClientAppActor pid=187008)[0m 
[36m(ClientAppActor pid=187008)[0m             This is a deprecated feature. It will be removed
[36m(ClientAppActor pid=187008)[0m             entirely in future versions of Flower.
[36m(ClientAppActor pid=187008)[0m         
[36m(ClientAppActor pid=187008)[0m [93mWARNING [0m:   Deprecation Warning: The `client_fn` function must return an instance of `Client`, but an instance of `NumpyClient` was returned. Please use `NumPyClient.to_client()` method to convert it to `Client`.
[92mINFO [0m:      aggregate_evaluate: received 2 results and 0 failures
[93mWARNING [0m:   No evaluate_metrics_aggregation_fn provided
[92mINFO [0m:      
[92mINFO [0m:      [ROUND 2]
[92mINFO [0m:      configure_fit: strategy sampled 2 clients (out of 2)
[36m(ClientAppActor pid=187008)[0m [93mWARNING [0m:   DEPRECATED FEATURE: `client_fn` now expects a signature `def client_fn(context: Context)`.The provided `client_fn` has signature: {'cid': <Parameter "cid: str">}. You can import the `Context` like this: `from flwr.common import Context`
[36m(ClientAppActor pid=187008)[0m 
[36m(ClientAppActor pid=187008)[0m             This is a deprecated feature. It will be removed
[36m(ClientAppActor pid=187008)[0m             entirely in future versions of Flower.
[36m(ClientAppActor pid=187008)[0m         
[36m(ClientAppActor pid=187008)[0m [93mWARNING [0m:   Deprecation Warning: The `client_fn` function must return an instance of `Client`, but an instance of `NumpyClient` was returned. Please use `NumPyClient.to_client()` method to convert it to `Client`.
[36m(ClientAppActor pid=187008)[0m [93mWARNING [0m:   DEPRECATED FEATURE: `client_fn` now expects a signature `def client_fn(context: Context)`.The provided `client_fn` has signature: {'cid': <Parameter "cid: str">}. You can import the `Context` like this: `from flwr.common import Context`
[36m(ClientAppActor pid=187008)[0m 
[36m(ClientAppActor pid=187008)[0m             This is a deprecated feature. It will be removed
[36m(ClientAppActor pid=187008)[0m             entirely in future versions of Flower.
[36m(ClientAppActor pid=187008)[0m         
[36m(ClientAppActor pid=187008)[0m [93mWARNING [0m:   Deprecation Warning: The `client_fn` function must return an instance of `Client`, but an instance of `NumpyClient` was returned. Please use `NumPyClient.to_client()` method to convert it to `Client`.
[92mINFO [0m:      aggregate_fit: received 2 results and 0 failures
[92mINFO [0m:      fit progress: (2, 1.0730984132699293, {'client0_meanDice': 0.011336341500282288, 'client0_WT': 0.00505289388820529, 'client0_TC': 0.010400332510471344, 'client0_ET': 0.01855579763650894, 'client1_meanDice': 0.011336341500282288, 'client1_WT': 0.00505289388820529, 'client1_TC': 0.010400332510471344, 'client1_ET': 0.01855579763650894, 'global_meanDice': 0.011336341500282288, 'global_WT': 0.00505289388820529, 'global_TC': 0.010400333441793919, 'global_ET': 0.01855579763650894}, 1081.5236369030317)
[92mINFO [0m:      configure_evaluate: strategy sampled 2 clients (out of 2)
[36m(ClientAppActor pid=187008)[0m [93mWARNING [0m:   DEPRECATED FEATURE: `client_fn` now expects a signature `def client_fn(context: Context)`.The provided `client_fn` has signature: {'cid': <Parameter "cid: str">}. You can import the `Context` like this: `from flwr.common import Context`
[36m(ClientAppActor pid=187008)[0m 
[36m(ClientAppActor pid=187008)[0m             This is a deprecated feature. It will be removed
[36m(ClientAppActor pid=187008)[0m             entirely in future versions of Flower.
[36m(ClientAppActor pid=187008)[0m         
[36m(ClientAppActor pid=187008)[0m [93mWARNING [0m:   Deprecation Warning: The `client_fn` function must return an instance of `Client`, but an instance of `NumpyClient` was returned. Please use `NumPyClient.to_client()` method to convert it to `Client`.
[36m(ClientAppActor pid=187008)[0m [93mWARNING [0m:   DEPRECATED FEATURE: `client_fn` now expects a signature `def client_fn(context: Context)`.The provided `client_fn` has signature: {'cid': <Parameter "cid: str">}. You can import the `Context` like this: `from flwr.common import Context`
[36m(ClientAppActor pid=187008)[0m 
[36m(ClientAppActor pid=187008)[0m             This is a deprecated feature. It will be removed
[36m(ClientAppActor pid=187008)[0m             entirely in future versions of Flower.
[36m(ClientAppActor pid=187008)[0m         
[36m(ClientAppActor pid=187008)[0m [93mWARNING [0m:   Deprecation Warning: The `client_fn` function must return an instance of `Client`, but an instance of `NumpyClient` was returned. Please use `NumPyClient.to_client()` method to convert it to `Client`.
[92mINFO [0m:      aggregate_evaluate: received 2 results and 0 failures
[92mINFO [0m:      
[92mINFO [0m:      [ROUND 3]
[92mINFO [0m:      configure_fit: strategy sampled 2 clients (out of 2)
[36m(ClientAppActor pid=187008)[0m [93mWARNING [0m:   DEPRECATED FEATURE: `client_fn` now expects a signature `def client_fn(context: Context)`.The provided `client_fn` has signature: {'cid': <Parameter "cid: str">}. You can import the `Context` like this: `from flwr.common import Context`
[36m(ClientAppActor pid=187008)[0m 
[36m(ClientAppActor pid=187008)[0m             This is a deprecated feature. It will be removed
[36m(ClientAppActor pid=187008)[0m             entirely in future versions of Flower.
[36m(ClientAppActor pid=187008)[0m         
[36m(ClientAppActor pid=187008)[0m [93mWARNING [0m:   Deprecation Warning: The `client_fn` function must return an instance of `Client`, but an instance of `NumpyClient` was returned. Please use `NumPyClient.to_client()` method to convert it to `Client`.
[36m(ClientAppActor pid=187008)[0m [93mWARNING [0m:   DEPRECATED FEATURE: `client_fn` now expects a signature `def client_fn(context: Context)`.The provided `client_fn` has signature: {'cid': <Parameter "cid: str">}. You can import the `Context` like this: `from flwr.common import Context`
[36m(ClientAppActor pid=187008)[0m 
[36m(ClientAppActor pid=187008)[0m             This is a deprecated feature. It will be removed
[36m(ClientAppActor pid=187008)[0m             entirely in future versions of Flower.
[36m(ClientAppActor pid=187008)[0m         
[36m(ClientAppActor pid=187008)[0m [93mWARNING [0m:   Deprecation Warning: The `client_fn` function must return an instance of `Client`, but an instance of `NumpyClient` was returned. Please use `NumPyClient.to_client()` method to convert it to `Client`.
[92mINFO [0m:      aggregate_fit: received 2 results and 0 failures
[91mERROR [0m:     [Errno 2] No such file or directory: '/home/bk489/federated/federated-thesis/data/partitions/federated_clients_2_70_30/client_data/client_0/train/slice_104_rank19.npz'
[91mERROR [0m:     Traceback (most recent call last):
  File "/home/bk489/.conda/envs/fed/lib/python3.9/site-packages/flwr/simulation/legacy_app.py", line 361, in start_simulation
    hist = run_fl(
  File "/home/bk489/.conda/envs/fed/lib/python3.9/site-packages/flwr/server/server.py", line 492, in run_fl
    hist, elapsed_time = server.fit(
  File "/home/bk489/.conda/envs/fed/lib/python3.9/site-packages/flwr/server/server.py", line 128, in fit
    res_cen = self.strategy.evaluate(current_round, parameters=self.parameters)
  File "/home/bk489/.conda/envs/fed/lib/python3.9/site-packages/flwr/server/strategy/fedavg.py", line 167, in evaluate
    eval_res = self.evaluate_fn(server_round, parameters_ndarrays, {})
  File "/home/bk489/federated/federated-thesis/federated_unet/unet/unet_flower_train_70_30.py", line 545, in evaluate_fn
    x0, _ = ds0[0]
  File "/home/bk489/federated/federated-thesis/federated_unet/unet/unet_flower_train_70_30.py", line 117, in __getitem__
    img, mask = _load_npz(self.files[idx])
  File "/home/bk489/federated/federated-thesis/federated_unet/unet/unet_flower_train_70_30.py", line 23, in _load_npz
    d = np.load(str(path), allow_pickle=False)
  File "/home/bk489/.conda/envs/fed/lib/python3.9/site-packages/numpy/lib/_npyio_impl.py", line 455, in load
    fid = stack.enter_context(open(os.fspath(file), "rb"))
FileNotFoundError: [Errno 2] No such file or directory: '/home/bk489/federated/federated-thesis/data/partitions/federated_clients_2_70_30/client_data/client_0/train/slice_104_rank19.npz'

[91mERROR [0m:     Your simulation crashed :(. This could be because of several reasons. The most common are: 
	 > Sometimes, issues in the simulation code itself can cause crashes. It's always a good idea to double-check your code for any potential bugs or inconsistencies that might be contributing to the problem. For example: 
		 - You might be using a class attribute in your clients that hasn't been defined.
		 - There could be an incorrect method call to a 3rd party library (e.g., PyTorch).
		 - The return types of methods in your clients/strategies might be incorrect.
	 > Your system couldn't fit a single VirtualClient: try lowering `client_resources`.
	 > All the actors in your pool crashed. This could be because: 
		 - You clients hit an out-of-memory (OOM) error and actors couldn't recover from it. Try launching your simulation with more generous `client_resources` setting (i.e. it seems {'num_cpus': 1, 'num_gpus': 1} is not enough for your run). Use fewer concurrent actors. 
		 - You were running a multi-node simulation and all worker nodes disconnected. The head node might still be alive but cannot accommodate any actor with resources: {'num_cpus': 1, 'num_gpus': 1}.
Take a look at the Flower simulation examples for guidance <https://flower.ai/docs/framework/how-to-run-simulations.html>.
Traceback (most recent call last):
  File "/home/bk489/.conda/envs/fed/lib/python3.9/site-packages/flwr/simulation/legacy_app.py", line 361, in start_simulation
    hist = run_fl(
  File "/home/bk489/.conda/envs/fed/lib/python3.9/site-packages/flwr/server/server.py", line 492, in run_fl
    hist, elapsed_time = server.fit(
  File "/home/bk489/.conda/envs/fed/lib/python3.9/site-packages/flwr/server/server.py", line 128, in fit
    res_cen = self.strategy.evaluate(current_round, parameters=self.parameters)
  File "/home/bk489/.conda/envs/fed/lib/python3.9/site-packages/flwr/server/strategy/fedavg.py", line 167, in evaluate
    eval_res = self.evaluate_fn(server_round, parameters_ndarrays, {})
  File "/home/bk489/federated/federated-thesis/federated_unet/unet/unet_flower_train_70_30.py", line 545, in evaluate_fn
    x0, _ = ds0[0]
  File "/home/bk489/federated/federated-thesis/federated_unet/unet/unet_flower_train_70_30.py", line 117, in __getitem__
    img, mask = _load_npz(self.files[idx])
  File "/home/bk489/federated/federated-thesis/federated_unet/unet/unet_flower_train_70_30.py", line 23, in _load_npz
    d = np.load(str(path), allow_pickle=False)
  File "/home/bk489/.conda/envs/fed/lib/python3.9/site-packages/numpy/lib/_npyio_impl.py", line 455, in load
    fid = stack.enter_context(open(os.fspath(file), "rb"))
FileNotFoundError: [Errno 2] No such file or directory: '/home/bk489/federated/federated-thesis/data/partitions/federated_clients_2_70_30/client_data/client_0/train/slice_104_rank19.npz'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/home/bk489/federated/federated-thesis/federated_unet/unet/unet_flower_train_70_30.py", line 711, in <module>
    main()
  File "/home/bk489/federated/federated-thesis/federated_unet/unet/unet_flower_train_70_30.py", line 602, in main
    history = fl.simulation.start_simulation(
  File "/home/bk489/.conda/envs/fed/lib/python3.9/site-packages/flwr/simulation/legacy_app.py", line 397, in start_simulation
    raise RuntimeError("Simulation crashed.") from ex
RuntimeError: Simulation crashed.
